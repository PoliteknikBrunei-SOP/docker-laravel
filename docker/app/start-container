#!/usr/bin/env bash

set -e  # Exit on any error

##
# Setup Composer cache directory with secure permissions
#
COMPOSER_HOME="/.composer"

if [ ! -d "$COMPOSER_HOME" ]; then
    mkdir -p "$COMPOSER_HOME"
    chown -R www-data:www-data "$COMPOSER_HOME"
fi

chmod -R 770 "$COMPOSER_HOME"  # Owner & group can read/write/execute

##
# Optional Laravel bootstrapping
#
LARAVEL_ROOT="/var/www/html"

if [ -f "$LARAVEL_ROOT/artisan" ]; then
    echo "ðŸ”§ Detected Laravel app. Running bootstrap commands..."
    
    # Set correct permissions for Laravel storage and cache dirs
    chown -R www-data:www-data "$LARAVEL_ROOT/storage" "$LARAVEL_ROOT/bootstrap/cache"
    chmod -R 775 "$LARAVEL_ROOT/storage" "$LARAVEL_ROOT/bootstrap/cache"

    # Run artisan boot commands
    sudo -u www-data php artisan config:clear
    sudo -u www-data php artisan config:cache
    sudo -u www-data php artisan route:cache || true  # allow failure (not all apps support it)
    sudo -u www-data php artisan view:cache
fi

##
# Run a command (like `php artisan migrate`) or start supervisord
#
if [ $# -gt 0 ]; then
    echo "ðŸ“¦ Running command: $@"
    exec "$@"
else
    echo "ðŸš€ Starting supervisord..."
    exec /usr/bin/supervisord
fi
